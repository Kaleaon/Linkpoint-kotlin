# Quick Batch Processing for Testing and Development
# Runs a lightweight version of the batch processing for testing purposes

name: Quick Batch Processing

on:
  # Allow manual triggering with options
  workflow_dispatch:
    inputs:
      demo_mode:
        description: 'Run in demonstration mode (no actual downloads)'
        required: false
        default: true
        type: boolean
      single_repo:
        description: 'Test with single repository (leave empty for demo mode)'
        required: false
        default: ''
        type: string
  
  # Run on pull requests affecting batch processing
  pull_request:
    paths:
      - 'batch-processor/**'
      - 'batch-download-convert.sh'
      - '.github/workflows/batch-processing*.yml'

jobs:
  quick-batch-test:
    name: Quick Batch Processing Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Kotlin
      uses: fwilhe2/setup-kotlin@main
      with:
        version: '1.9.20'
    
    - name: Prepare environment
      run: |
        chmod +x batch-download-convert.sh
        chmod +x batch-processor/demo-batch-processing.sh
        mkdir -p batch-processor/{downloads,converted,reports}
    
    - name: Run demonstration mode
      if: ${{ github.event.inputs.demo_mode == 'true' || github.event.inputs.demo_mode == '' }}
      run: |
        echo "ðŸŽ¯ Running Batch Processing Demonstration"
        echo "========================================"
        cd batch-processor
        ./demo-batch-processing.sh
    
    - name: Run single repository test
      if: ${{ github.event.inputs.single_repo != '' && github.event.inputs.demo_mode != 'true' }}
      env:
        TEST_REPO: ${{ github.event.inputs.single_repo }}
      run: |
        echo "ðŸ§ª Testing Single Repository: $TEST_REPO"
        echo "======================================="
        
        # Create a minimal test version of the script
        cat > test-single-repo.sh << 'EOF'
        #!/bin/bash
        cd batch-processor/downloads
        echo "ðŸ“¦ Testing download of $TEST_REPO..."
        
        case "$TEST_REPO" in
          "secondlife-viewer")
            git clone --depth 1 https://github.com/secondlife/viewer.git secondlife-viewer
            ;;
          "firestorm-viewer")  
            git clone --depth 1 https://github.com/FirestormViewer/phoenix-firestorm.git firestorm-viewer
            ;;
          "libremetaverse")
            git clone --depth 1 https://github.com/openmetaversefoundation/libopenmetaverse.git libremetaverse
            ;;
          "restrained-love-viewer")
            git clone --depth 1 https://github.com/RestrainedLove/RestrainedLove.git restrained-love-viewer
            ;;
          *)
            echo "âŒ Unknown repository: $TEST_REPO"
            exit 1
            ;;
        esac
        
        echo "âœ… Download test completed"
        EOF
        
        chmod +x test-single-repo.sh
        ./test-single-repo.sh
    
    - name: Validate batch processing system
      run: |
        echo "âœ… Validation Results"
        echo "===================="
        
        # Check core components exist
        echo "ðŸ“‹ Core Components:"
        [ -f "batch-processor/src/main/kotlin/com/linkpoint/batch/BatchProcessor.kt" ] && echo "  âœ… BatchProcessor.kt" || echo "  âŒ BatchProcessor.kt missing"
        [ -f "batch-processor/src/main/kotlin/com/linkpoint/batch/CodeConverter.kt" ] && echo "  âœ… CodeConverter.kt" || echo "  âŒ CodeConverter.kt missing"
        [ -f "batch-processor/src/main/kotlin/com/linkpoint/batch/LLSDLabeler.kt" ] && echo "  âœ… LLSDLabeler.kt" || echo "  âŒ LLSDLabeler.kt missing"
        [ -f "batch-processor/src/main/kotlin/com/linkpoint/batch/ProgressTracker.kt" ] && echo "  âœ… ProgressTracker.kt" || echo "  âŒ ProgressTracker.kt missing"
        
        echo ""
        echo "ðŸ“„ Documentation:"
        [ -f "BATCH_PROCESSING_GUIDE.md" ] && echo "  âœ… Batch Processing Guide" || echo "  âŒ Guide missing"
        [ -f "batch-processor/README.md" ] && echo "  âœ… Module README" || echo "  âŒ README missing"
        
        echo ""
        echo "ðŸ”§ Scripts:"
        [ -x "batch-download-convert.sh" ] && echo "  âœ… Main batch script executable" || echo "  âŒ Main script not executable"
        [ -x "batch-processor/demo-batch-processing.sh" ] && echo "  âœ… Demo script executable" || echo "  âŒ Demo script not executable"
        
        echo ""
        echo "ðŸ“ Directory Structure:"
        [ -d "batch-processor/downloads" ] && echo "  âœ… Downloads directory" || echo "  âŒ Downloads directory missing"
        [ -d "batch-processor/converted" ] && echo "  âœ… Converted directory" || echo "  âŒ Converted directory missing"
        [ -d "batch-processor/reports" ] && echo "  âœ… Reports directory" || echo "  âŒ Reports directory missing"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quick-batch-test-results
        path: |
          batch-processor/converted/
          batch-processor/reports/
          batch-processor/downloads/
        retention-days: 3